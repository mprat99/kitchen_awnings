<!DOCTYPE html>
<html>
  <head>
    <title>Kitchen Awnings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/style.css">
  </head>
  <body>
    <div id="rain-container" style="display: none;"></div>
    <div style="display: flex; justify-content: center; margin-bottom: 1em">
      <h1>Kitchen Awnings</h1>
    </div>

    <!-- Battery info -->
    <div class="top-info">
      <span>Battery Voltage: <span id="batteryVoltage">-</span> V</span>&nbsp;&nbsp;|&nbsp;&nbsp;
      <span>Battery Current: <span id="batteryCurrent">-</span> mA</span>&nbsp;&nbsp;|&nbsp;&nbsp;
      <span>PV Current: <span id="pvCurrent">-</span> mA</span>
    </div>

    <!-- Control buttons -->
    <div style="display: flex; justify-content: center;">
      <table style="table-layout: fixed;">
        <tr>
          <td><button class="button" id="up0" onclick="buttonClick(this)">UP</button></td>
          <td><button class="button" id="up1" onclick="buttonClick(this)">UP</button></td>
        </tr>
        <tr>
          <td><button class="button" id="stop0" onclick="buttonClick(this)">STOP</button></td>
          <td><button class="button" id="stop1" onclick="buttonClick(this)">STOP</button></td>
        </tr>
        <tr>
          <td><button class="button" id="down0" onclick="buttonClick(this)">DOWN</button></td>
          <td><button class="button" id="down1" onclick="buttonClick(this)">DOWN</button></td>
        </tr>
        <tr>
          <td style="text-align: center; color: lightgrey; padding-top: 1em;">
            <span id="reason0">Power-on</span>
          </td>
          <td style="text-align: center; color: lightgrey; padding-top: 1em;">
            <span id="reason1">Power-on</span>
          </td>
        </tr>
        <tr>
          <td style="text-align: center; color: lightgrey; padding-bottom: 1em;">
            <span id="moveTime0">00:00h</span>
          </td>
          <td style="text-align: center; color: lightgrey; padding-bottom: 1em;">
            <span id="moveTime1">00:00h</span>
          </td>
        </tr>
        <tr>
          <td class="awning-container">
            <div class="awning">
              <div class="rectangle">
                <div class="fill" id="fill0"></div>
              </div>
            </div>
          </td>
          <td class="awning-container">
            <div class="awning">
              <div class="rectangle">
                <div class="fill" id="fill1"></div>
              </div>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <hr style="margin-top: 5em;">

    <!-- Automatic Day/Night -->
    <div style="display: flex; justify-content: center;">
      <span style="margin-bottom: 1em; margin-top: 1em">Automatic Day / Night</span>
    </div>
    <div style="display: flex; justify-content: center;margin-bottom: 1em;">
      <label class="switch">
        <input type="checkbox" id="toggleSwitch">
        <span class="slider round"></span>
      </label>
    </div>

  <div style="display: flex; justify-content: center; gap: 0.5em; font-size: 2em;">
    <!-- Morning column -->
    <div style="display: flex; flex-direction: column; align-items: center;">
      <div style="display: flex; align-items: center;">
        <input class="time" type="number" id="morningHour">
        <span>:</span>
        <input class="time" type="number" id="morningMinute">
        <span style="margin-left: 0.5em;">h</span>
      </div>
      <div style="color: lightgrey; font-size: 0.55em; margin-top: 1em; margin-left: -2em;">
        Sunrise: <span id="sunrise">--:--h</span>
      </div>
    </div>

    <!-- Night column -->
    <div style="display: flex; flex-direction: column; align-items: center;">
      <div style="display: flex; align-items: center;">
        <input class="time" type="number" id="nightHour">
        <span>:</span>
        <input class="time" type="number" id="nightMinute">
        <span style="margin-left: 0.5em;">h</span>
      </div>
      <div style="color: lightgrey; font-size: 0.55em; margin-top: 1em; margin-left: -2em;">
        Sunset: <span id="sunset">--:--h</span>
      </div>
    </div>
  </div>

    <!-- <hr style="margin-top: 5em;"> -->

<!-- Row with all 3 switches -->
<div class="switch-row">

  <!-- Solar charger -->
  <div style="text-align: center;">
    <span style="display: block; margin-bottom: 0.5em;">Solar Charger</span>
    <label class="switch">
      <input type="checkbox" id="solarChargerSwitch">
      <span class="slider round"></span>
    </label>
  </div>

  <!-- Rain sensor -->
  <div style="text-align: center;">
    <span style="display: block; margin-bottom: 0.5em;">Rain Sensor</span>
    <label class="switch">
      <input type="checkbox" id="rainSensorSwitch">
      <span class="slider round"></span>
    </label>
  </div>

  <!-- 12V output -->
  <div style="text-align: center;">
    <span style="display: block; margin-bottom: 0.5em;">12V Output</span>
    <label class="switch">
      <input type="checkbox" id="output12VSwitch">
      <span class="slider round"></span>
    </label>
  </div>

</div>


    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 6em;">
      <button class="button-save" id="saveTime">SAVE</button>
    </div>

    <hr style="margin-top: 3em;">
    <div style="display: flex; justify-content: center; align-items: center; margin-top: 1em; text-align: center;">
      Use these buttons to set the current position as the end of the awning
    </div>

    <div style="display: flex; justify-content: center; margin-top: 2em">
      <table style="table-layout: fixed;">
        <tr>
          <td><button class="button" id="end0" onclick="configure('end0')">Configure</button></td>
          <td><button class="button" id="save0" onclick="configure('save0')" hidden>SAVE</button></td>
          <td><button class="button" id="end1" onclick="configure('end1')">Configure</button></td>
          <td><button class="button" id="save1" onclick="configure('save1')" hidden>SAVE</button></td>
        </tr>
      </table>
    </div>

    <hr style="margin-top: 1em;">
    <span style="display: flex; justify-content: center; margin-top: 1em">
      Use this button to reset the home position
    </span>
    <div style="display: flex; justify-content: center; margin-top: 2em">
      <table style="table-layout: fixed;">
        <tr>
          <td><button class="button" id="home" onclick="home()">HOME</button></td>
        </tr>
      </table>
    </div>

    <hr style="margin-top: 1em;">
    <div style="display: flex; justify-content: center;">
      <span style="margin-bottom: 1em; margin-top: 1em">WiFi Configuration</span>
    </div>

    <div style="display: flex; justify-content: center; font-size: 2em;">
      <input style="margin-right: 1em; height: 3em; border-radius: 0.5em; text-align: center; width: 35%" placeholder="SSID" id="ssid">
      <input style="margin-left: 1em; border-radius: 0.5em; text-align: center; width: 35%" placeholder="Password" type="password" id="password">
    </div>

    <div style="display: flex; justify-content: center;">
      <span style="margin-bottom: 1em; margin-top: 1em">IP Address: <span id="ipAddress">192.168.1.155</span></span>
    </div>

    <div style="display: flex; justify-content: center;">
      <button class="button-save" style="margin-top:0" id="saveWifi" onclick="saveWifi()">SAVE</button>
    </div>

    <hr style="margin-top: 4em;">
    <div style="display: flex; justify-content: center; margin-top: 1em">
      <button class="button" id="resetButton" onclick="resetESP()">RESET ESP32</button>
    </div>

    <script>
      const awningPosition = [0, 0];
      const distance = [0, 0];
      const direction = ["up", "up"];
      const awningAnimation = [null, null];
      let raining = false;
      let firstLoad = true;

      function buttonClick(button) {

          const index = button.id.slice(-1);
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/move");
          xhr.setRequestHeader("Content-Type", "application/json");

          xhr.onload = function () {
              if (xhr.status === 200) {
                  // Only proceed if response is OK
                  if (button.id.startsWith("up")) {
                      document.getElementById("reason" + index).textContent = "Remote Button";
                      direction[index] = "up";
                      startAnimation("fill" + index);
                      document.getElementById("output12VSwitch").checked = true;
                  } else if (button.id.startsWith("down")) {
                      document.getElementById("reason" + index).textContent = "Remote Button";
                      direction[index] = "down";
                      startAnimation("fill" + index);
                      document.getElementById("output12VSwitch").checked = true;
                  } else if (button.id.startsWith("stop")) {
                      cancelAnimation(index);
                  }
              } else {
                  console.error("Request failed with status:", xhr.status);
              }
          };

          xhr.onerror = function () {
              console.error("Network error occurred.");
          };

          xhr.send(JSON.stringify({ buttonId: button.id }));
      }

      function configure(buttonId) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/setEndPosition");
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            // Toggle visibility based on which button was clicked
            if (buttonId === "end0") {
              document.getElementById("end0").hidden = true;
              document.getElementById("save0").hidden = false;
            } else if (buttonId === "save0") {
              document.getElementById("save0").hidden = true;
              document.getElementById("end0").hidden = false;
            } else if (buttonId === "end1") {
              document.getElementById("end1").hidden = true;
              document.getElementById("save1").hidden = false;
            } else if (buttonId === "save1") {
              document.getElementById("save1").hidden = true;
              document.getElementById("end1").hidden = false;
            }
          }
        };

        xhr.send(JSON.stringify({ buttonId: buttonId }));
      }


      function home() {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/setHome");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify({}));
      }

      function saveWifi() {
        var ssid = document.getElementById("ssid").value;
        var password = document.getElementById("password").value;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/saveWifi");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify({ ssid, password }));
      }

      // animate fill from current percentage
      function startAnimation(id) {
        const index = parseInt(id.slice(-1));
        const fillElement = document.getElementById(id);
        cancelAnimation(index);
        const speed = 0.05; // % per frame

        function animate() {
          if (direction[index] === "down") {
            awningPosition[index] += speed;
            if (awningPosition[index] > 100) awningPosition[index] = 100;
          } else if (direction[index] === "up") {
            awningPosition[index] -= speed;
            if (awningPosition[index] < 0) awningPosition[index] = 0;
          }

          fillElement.style.transform = `scaleY(${awningPosition[index] / 100})`;

          if ((direction[index] === "down" && awningPosition[index] < 100) ||
              (direction[index] === "up" && awningPosition[index] > 0)) {
            awningAnimation[index] = requestAnimationFrame(animate);
          } else {
            awningAnimation[index] = null;
          }
        }

        animate();
      }

      function cancelAnimation(index) {
        if (awningAnimation[index]) {
          cancelAnimationFrame(awningAnimation[index]);
          awningAnimation[index] = null;
        }
      }

      async function fetchData() {
        try {
          const response = await fetch("/data");
          if (!response.ok) throw new Error("Network response not ok");
          const data = await response.json();

          // Update static info
          document.getElementById("batteryVoltage").textContent = data.batteryVoltage.toFixed(2);
          document.getElementById("batteryCurrent").textContent = data.batteryCurrent.toFixed(2);
          document.getElementById("pvCurrent").textContent      = data.pvCurrent.toFixed(2);

          raining = data.raining;
          updateRainStatus(raining);

          distance[0] = data.dist0;
          distance[1] = data.dist1;

          [0,1].forEach(index => {
            const serverPercent = (index === 0 ? data.awning0Percent : data.awning1Percent);

            if (firstLoad || awningAnimation[index] == null) {
              // On first load OR if idle → sync to server
              awningPosition[index] = serverPercent;
              document.getElementById("fill" + index).style.transform =
                `scaleY(${awningPosition[index] / 100})`;

              // If motor moving, start animation in correct direction
              if (distance[index] !== 0) {
                if (index === 0) {
                  direction[index] = distance[index] < 0 ? "up" : "down";
                } else {
                  direction[index] = distance[index] < 0 ? "down" : "up";
                }
                startAnimation("fill" + index);
              }
            } else {
              // Already animating → don’t reset percent, only react to stop/reverse
              if (distance[index] === 0) {
                cancelAnimation(index);
              } else {
                let newDir;
                if (index === 0) {
                  newDir = distance[index] < 0 ? "up" : "down";
                } else {
                  newDir = distance[index] < 0 ? "down" : "up";
                }
                if (newDir !== direction[index]) {
                  direction[index] = newDir;
                  startAnimation("fill" + index); // restart with new direction
                }
              }
            }
          });

          firstLoad = false;
        } catch (err) {
          console.error("Fetch error:", err);
        }
      }

      // Update every 2 seconds
      setInterval(fetchData, 2000);

      // Fetch once immediately on page load
      fetchData();

      let originalConfig = {};  // store original values from server

      async function fetchConfig() {
        try {
          const response = await fetch("/config");
          if (!response.ok) throw new Error("Network response not ok");
          const config = await response.json();

          // Save reference for change detection
          originalConfig = {
            automaticDayNight: !!config.automaticDayNight,
            morningHour: config.morningHour,
            morningMinute: config.morningMinute,
            nightHour: config.nightHour,
            nightMinute: config.nightMinute,
            rainSensorEnabled: !!config.rainSensorEnabled,
            output12VEnabled: !!config.output12VEnabled,
            solarChargerEnabled: !!config.solarChargerEnabled
          };

          // Fill UI
          document.getElementById("toggleSwitch").checked = originalConfig.automaticDayNight;
          document.getElementById("morningHour").value    = String(originalConfig.morningHour).padStart(2, "0");
          document.getElementById("morningMinute").value  = String(originalConfig.morningMinute).padStart(2, "0");
          document.getElementById("nightHour").value      = String(originalConfig.nightHour).padStart(2, "0");
          document.getElementById("nightMinute").value    = String(originalConfig.nightMinute).padStart(2, "0");
          document.getElementById("rainSensorSwitch").checked = originalConfig.rainSensorEnabled;
          document.getElementById("output12VSwitch").checked = originalConfig.output12VEnabled;
          document.getElementById("solarChargerSwitch").checked = originalConfig.solarChargerEnabled;
          document.getElementById("reason0").textContent = config.positionReason0;
          document.getElementById("reason1").textContent = config.positionReason1;
          document.getElementById("moveTime0").textContent = config.moveTime0;
          document.getElementById("moveTime1").textContent = config.moveTime1;
          if (config.sunrise.length == 6) {
            document.getElementById("sunrise").textContent = config.sunrise;
            document.getElementById("sunset").textContent = config.sunset;
          }
          hideSaveButton(); // reset save button
        } catch (err) {
          console.error("Fetch config error:", err);
        }
      }

      function checkForChanges() {
        const current = {
          automaticDayNight: document.getElementById("toggleSwitch").checked,
          morningHour: parseInt(document.getElementById("morningHour").value) || 0,
          morningMinute: parseInt(document.getElementById("morningMinute").value) || 0,
          nightHour: parseInt(document.getElementById("nightHour").value) || 0,
          nightMinute: parseInt(document.getElementById("nightMinute").value) || 0,
          rainSensorEnabled: document.getElementById("rainSensorSwitch").checked,
          output12VEnabled: document.getElementById("output12VSwitch").checked,
          solarChargerEnabled: document.getElementById("solarChargerSwitch").checked
        };

        // Compare JSON representations
        if (JSON.stringify(current) !== JSON.stringify(originalConfig)) {
          showSaveButton();
        } else {
          hideSaveButton();
        }
      }

      function showSaveButton() {
        document.getElementById("saveTime").hidden = false;
      }
      function hideSaveButton() {
        document.getElementById("saveTime").hidden = true;
      }

      async function saveConfig() {
        const newConfig = {
          scheduled: document.getElementById("toggleSwitch").checked ? 1 : 0,
          morningHour: parseInt(document.getElementById("morningHour").value) || 0,
          morningMinute: parseInt(document.getElementById("morningMinute").value) || 0,
          nightHour: parseInt(document.getElementById("nightHour").value) || 0,
          nightMinute: parseInt(document.getElementById("nightMinute").value) || 0,
          rainSensorEnabled: document.getElementById("rainSensorSwitch").checked ? 1 : 0,
          output12VEnabled: document.getElementById("output12VSwitch").checked ? 1 : 0,
          solarChargerEnabled: document.getElementById("solarChargerSwitch").checked ? 1 : 0
        };

        try {
          const response = await fetch("/saveConfig", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newConfig)
          });
          if (!response.ok) throw new Error("Save failed");

          // Refresh originalConfig and hide save button
          originalConfig = { ...newConfig, automaticDayNight: !!newConfig.scheduled };
          hideSaveButton();
        } catch (err) {
          console.error("Save error:", err);
        }
      }

      // Hook change detection
      document.addEventListener("DOMContentLoaded", () => {
        fetchConfig(); // load initial config

        document.getElementById("toggleSwitch").addEventListener("change", checkForChanges);
        document.getElementById("morningHour").addEventListener("input", checkForChanges);
        document.getElementById("morningMinute").addEventListener("input", checkForChanges);
        document.getElementById("nightHour").addEventListener("input", checkForChanges);
        document.getElementById("nightMinute").addEventListener("input", checkForChanges);
        document.getElementById("rainSensorSwitch").addEventListener("change", checkForChanges);
        document.getElementById("output12VSwitch").addEventListener("change", checkForChanges);
        document.getElementById("solarChargerSwitch").addEventListener("change", checkForChanges);

        document.getElementById("saveTime").addEventListener("click", saveConfig);
      });

      function resetESP() {
        if (confirm("Are you sure you want to reset the ESP32?")) {
          fetch("/reset", { method: "POST" })
            .then(response => {
              if (response.ok) {
                alert("ESP32 is restarting...");
              } else {
                alert("Reset failed.");
              }
            })
            .catch(err => {
              console.error("Reset error:", err);
              alert("Error sending reset request.");
            });
        }
      }

      function createRainDrops(container, count = 80) {
        container.innerHTML = ''; // Clear previous drops
        for (let i = 0; i < count; i++) {
          const drop = document.createElement('div');
          drop.className = 'raindrop';
          drop.style.left = `${Math.random() * window.innerWidth}px`;
          drop.style.animationDuration = `${1.5 + Math.random() * 2}s`;
          drop.style.animationDelay = `${Math.random() * 3}s`;
          container.appendChild(drop);
        }
      }

      function updateRainStatus(raining) {
        const rainContainer = document.getElementById('rain-container');
        if (raining) {
          rainContainer.style.display = 'block';
          if (rainContainer.children.length === 0) {
            createRainDrops(rainContainer);
          }
        } else {
          rainContainer.style.display = 'none';
          rainContainer.innerHTML = ''; // Optional: remove drops
        }
      }


    </script>
  </body>
</html>
